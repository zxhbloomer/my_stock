# 滚动窗口验证使用说明

## 概述

滚动窗口验证是评估量化策略稳健性的关键步骤。通过在多个连续时间段上测试策略，可以：
- ✅ 检测策略是否存在过拟合
- ✅ 评估策略在不同市场环境下的表现
- ✅ 识别策略衰减趋势
- ✅ 决定是否适合实盘交易

## 快速开始

### 1. 运行滚动窗口验证（自动生成图表）

```bash
# 默认配置：7年训练 + 2年验证 + 1年测试
C:\Users\Administrator\miniconda3\envs\mystock\python.exe scripts\40_模型验证\40_滚动窗口验证.py --config configs/workflow_config_top50_optimized.yaml
```

**自动执行流程**：
1. 运行多期滚动验证（2017-2023共7期）
2. 保存所有结果到MLflow实验 `rolling_validation`
3. 自动调用可视化脚本
4. 生成4种图表 + HTML报告

**输出位置**：
- MLflow记录：`mlruns/` 目录（可用 `mlflow ui` 查看）
- 图表文件：`validation_results/charts/`
- HTML报告：`validation_results/charts/rolling_validation_report.html`

### 2. 自定义验证参数

```bash
# 修改时间窗口大小
C:\Users\Administrator\miniconda3\envs\mystock\python.exe scripts\40_模型验证\40_滚动窗口验证.py \
  --config configs/workflow_config_top50_optimized.yaml \
  --train-years 5 \
  --valid-years 1 \
  --test-years 2

# 指定验证时间范围（只验证2015-2020）
C:\Users\Administrator\miniconda3\envs\mystock\python.exe scripts\40_模型验证\40_滚动窗口验证.py \
  --config configs/workflow_config_top50_optimized.yaml \
  --start-year 2015 \
  --end-year 2020

# 不自动生成图表（只做验证）
C:\Users\Administrator\miniconda3\envs\mystock\python.exe scripts\40_模型验证\40_滚动窗口验证.py \
  --config configs/workflow_config_top50_optimized.yaml \
  --no-charts
```

### 3. 单独生成可视化报告

如果之前跳过了图表生成，可以手动运行：

```bash
C:\Users\Administrator\miniconda3\envs\mystock\python.exe scripts\result\滚动验证可视化.py
```

## 工作流程详解

### 阶段1: 滚动窗口验证 (40_滚动窗口验证.py)

**功能**：
- 自动生成多个滚动时间窗口
- 在每个窗口上训练模型并测试
- 计算IC指标（IC均值、IC_IR、IC正值占比等）
- 保存所有结果到MLflow

**时间窗口示例**（默认：6年训练+2年验证+1年测试）：
```
测试期1: 2017
├─ 训练: 2008-2013 (6年)
├─ 验证: 2014-2015 (2年)
└─ 测试: 2017 (1年)

测试期2: 2018
├─ 训练: 2009-2014
├─ 验证: 2015-2016
└─ 测试: 2018

... (依此类推)
```

**MLflow记录内容**：
- **参数(params)**: 训练/验证/测试时间段
- **指标(metrics)**: IC均值、IC_IR、IC正值占比、有效天数
- **对象(objects)**: 模型文件、预测结果、每日IC序列

### 阶段2: 可视化报告生成 (滚动验证可视化.py)

**功能**：
- 从MLflow加载所有验证结果
- 生成4类专业图表
- 生成包含完整分析的HTML报告

**生成的图表**：

1. **IC时序图** (`01_ic_timeseries.png`)
   - IC均值随时间变化趋势
   - IC_IR（信息比率）变化趋势
   - 标注优秀/可接受阈值线

2. **IC分布图** (`02_ic_distribution.png`)
   - IC均值的分布情况（小提琴图）
   - IC标准差柱状图（波动性分析）

3. **稳定性分析图** (`03_stability_analysis.png`)
   - IC正值占比（预测准确率）
   - 有效交易日数（数据覆盖度）
   - 风险-收益散点图
   - 策略衰减趋势（线性拟合）

4. **性能热力图** (`04_performance_heatmap.png`)
   - 多指标综合对比
   - 颜色编码性能评分

**HTML报告内容**：
- 📊 汇总卡片：关键指标一览
- 📈 图表展示：所有4张图表嵌入
- 🎯 实盘建议：基于IC表现自动生成
- 📋 详细数据表：所有测试期完整数据

## 结果解读

### IC指标含义

| 指标 | 含义 | 优秀标准 | 可接受标准 |
|------|------|----------|-----------|
| **IC均值** | 预测与真实收益的相关性 | > 0.03 | > 0.01 |
| **IC标准差** | IC的波动程度 | < 0.05 | < 0.10 |
| **IC_IR** | IC均值/IC标准差（信息比率） | > 1.0 | > 0.5 |
| **IC正值占比** | IC>0的交易日比例 | > 70% | > 55% |

### 实盘决策标准

根据验证结果判断是否适合实盘：

✅ **可以实盘** (小资金测试)
- 平均IC > 0.03
- 70%以上测试期IC > 0.03
- 无明显衰减趋势（衰减率 > -0.005）

⚠️ **需要优化** (建议模拟盘)
- 平均IC在 0.02-0.03之间
- 50%-70%测试期表现良好
- 存在轻微衰减

❌ **不建议实盘**
- 平均IC < 0.02
- IC正值占比 < 50%
- 明显的策略衰减

### 示例分析

**案例：策略衰减检测**

假设验证结果显示：
```
Test_2017: IC=0.0788 ⭐⭐⭐
Test_2018: IC=0.0510 ⭐⭐
Test_2019: IC=0.0455 ⭐
Test_2020: IC=0.0364 ⭐
Test_2021: IC=0.0277 ⚠️
Test_2022: IC=0.0237 ⚠️
Test_2023: IC=0.0214 ⚠️
```

**结论**：
- IC从0.0788下降到0.0214（73%衰减）
- 存在明显的策略失效趋势
- 不建议实盘，需要用更近期数据重新训练

## 与MLflow交互

### 查看实验记录

```bash
# 启动MLflow UI
mlflow ui

# 浏览器访问
http://localhost:5000

# 在UI中查看 'rolling_validation' 实验
```

### 加载特定期的结果

```python
from qlib.workflow import R

# 从CSV或HTML报告中获取recorder_id
recorder = R.get_recorder(
    recorder_id='your_recorder_id_here',
    experiment_name='rolling_validation'
)

# 加载模型和预测结果
model = recorder.load_object('model.pkl')
pred = recorder.load_object('pred.pkl')
daily_ic = recorder.load_object('daily_ic.pkl')

# 查看参数
params = recorder.list_params()
print(f"测试期: {params['period_name']}")
print(f"训练时间: {params['train_start']} - {params['train_end']}")

# 查看指标
metrics = recorder.list_metrics()
print(f"IC均值: {metrics['ic_mean']:.4f}")
print(f"IC_IR: {metrics['ic_ir']:.4f}")
```

## 常见问题

### Q1: 验证需要多长时间？
**A**: 取决于测试期数和数据量。典型配置（7个测试期，CSI500）约需30-60分钟。

### Q2: 如何只验证最近几年？
**A**: 使用 `--start-year` 和 `--end-year` 参数：
```bash
python scripts/50_滚动窗口验证.py \
  --config configs/workflow_config_top50_optimized.yaml \
  --start-year 2020 \
  --end-year 2025
```

### Q3: 可视化脚本失败怎么办？
**A**:
1. 确认MLflow中有数据：`mlflow ui` 查看 `rolling_validation` 实验
2. 检查是否有recorder记录
3. 手动运行可视化脚本查看错误信息

### Q4: 如何调整时间窗口大小？
**A**: 使用参数调整：
```bash
# 更长的训练期（8年训练）
--train-years 8

# 更短的测试期（半年测试）
--test-years 0.5  # 注意：需要修改代码支持小数

# 建议配置
--train-years 6 --valid-years 2 --test-years 1  # 稳健
--train-years 5 --valid-years 1 --test-years 1  # 快速迭代
```

### Q5: 图表不显示中文怎么办？
**A**: 确保系统安装了中文字体（SimHei或Microsoft YaHei）。可视化脚本已配置字体回退方案。

## 完整工作流示例

**从参数优化到滚动验证到实盘决策**：

```bash
# 步骤1: 参数优化（如果需要）
python scripts/40_参数优化_生成新yaml.py

# 步骤2: 滚动窗口验证（自动生成图表）
C:\Users\Administrator\miniconda3\envs\mystock\python.exe \
  scripts/50_滚动窗口验证.py \
  --config configs/workflow_config_top50_optimized.yaml

# 步骤3: 打开HTML报告查看结果
# 位置: validation_results/charts/rolling_validation_report.html

# 步骤4: 启动MLflow UI查看详细记录
mlflow ui

# 步骤5: 根据报告建议决定是否实盘
```

## 文件结构

```
my_stock/
├── scripts/
│   ├── 50_滚动窗口验证.py          # 主验证脚本
│   └── result/
│       └── 滚动验证可视化.py        # 可视化脚本
├── configs/
│   └── workflow_config_top50_optimized.yaml  # 配置文件
├── validation_results/
│   └── charts/                    # 图表输出目录
│       ├── 01_ic_timeseries.png
│       ├── 02_ic_distribution.png
│       ├── 03_stability_analysis.png
│       ├── 04_performance_heatmap.png
│       └── rolling_validation_report.html
└── mlruns/                        # MLflow实验记录
    └── [experiment_id]/
        └── rolling_validation/
```

## 参考资料

- [Qlib官方文档 - Rolling Benchmark](https://qlib.readthedocs.io/)
- [MLflow文档](https://mlflow.org/docs/latest/index.html)
- [IC指标详解](https://www.quantopian.com/posts/information-coefficient-ic)

---

**最后更新**: 2025-11-16
**版本**: v1.0

# 📊 Qlib量化分析图表查看指南

## 方式1: 查看静态图表 (推荐!)

### 运行命令
```bash
conda activate mystock
python view_charts.py
```

### 查看图表
生成的图表文件: **backtest_analysis.png** (470KB)

**包含9个分析视图**:
1. **IC时间序列** - 预测质量随时间的变化
2. **IC分布** - 预测质量的统计分布
3. **累积收益曲线** - 策略 vs 基准的收益对比
4. **超额收益(无成本)** - 理论最佳收益
5. **超额收益(含成本)** - 实际可获得收益
6. **回撤曲线** - 风险控制情况
7. **预测分数分布** - 模型输出分布
8. **每日换手率** - 交易频率
9. **关键指标对比** - 年化收益、信息比率等

### 如何打开
- **Windows**: 双击 `backtest_analysis.png` 文件
- **或**: 用任何图片查看器打开

---

## 方式2: 使用MLflow UI (交互式)

### 启动服务
```bash
conda activate mystock
mlflow ui --port 5000 --backend-store-uri file:./mlruns
```

### 访问界面
打开浏览器访问: **http://127.0.0.1:5000**

### 功能
- 📁 查看所有实验记录
- 📊 对比不同实验结果
- 📈 查看训练过程
- 💾 下载模型和预测结果
- 🔍 搜索和过滤实验

### 关闭服务
按 `Ctrl+C` 停止MLflow UI服务

---

## 方式3: 在Jupyter Notebook中查看

### 启动Jupyter
```bash
conda activate mystock
cd notebooks
jupyter notebook
```

### 创建新笔记本并运行
```python
import qlib
from qlib.workflow import R
from qlib.contrib.report import analysis_model, analysis_position

# 初始化
qlib.init(provider_uri="~/.qlib/qlib_data/cn_data", region="cn")

# 加载回测记录
recorder = R.get_recorder(
    recorder_id="<您的recorder_id>",
    experiment_name="backtest_analysis"
)

# 加载数据
pred_df = recorder.load_object("pred.pkl")
label_df = recorder.load_object("label.pkl")
report_df = recorder.load_object("portfolio_analysis/report_normal_1day.pkl")
analysis_df = recorder.load_object("portfolio_analysis/port_analysis_1day.pkl")

# 生成交互式图表
pred_label = pd.concat([label_df, pred_df], axis=1)
pred_label.columns = ['label', 'score']

# 1. IC分数图
analysis_position.score_ic_graph(pred_label)

# 2. 模型性能图
analysis_model.model_performance_graph(pred_label)

# 3. 投资组合报告图
analysis_position.report_graph(report_df)

# 4. 风险分析图
analysis_position.risk_analysis_graph(analysis_df, report_df)
```

---

## 📝 各图表解读

### IC (Information Coefficient)
- **含义**: 预测分数与真实收益的相关性
- **好的IC**: > 0.03 (月度), > 0.01 (日度)
- **我们的结果**: IC=0.052, Rank IC=0.055 ✅ 优秀!

### 年化收益率
- **无成本**: 14.84%
- **含成本**: 11.18%
- **超越基准**: 相对CSI300基准的超额收益

### 信息比率 (IR)
- **含义**: 单位风险的超额收益
- **好的IR**: > 1.0
- **我们的结果**: IR=1.71 (无成本), IR=1.29 (含成本) ✅ 优秀!

### 最大回撤 (MDD)
- **含义**: 最大损失幅度
- **我们的结果**: -8.57% (无成本), -8.83% (含成本)
- **风险控制**: 相对温和

### 换手率
- **含义**: 每日交易比例
- **影响**: 高换手率 → 高交易成本
- **策略**: TopkDropout (topk=50, n_drop=5)

---

## 🎯 快速查看总结

**最简单的方式**:
```bash
python view_charts.py
# 然后打开 backtest_analysis.png
```

**最专业的方式**:
```bash
mlflow ui --port 5000
# 然后访问 http://127.0.0.1:5000
```

**最灵活的方式**:
```bash
jupyter notebook
# 在笔记本中运行Qlib官方分析函数
```

---

## ⚠️ 注意事项

1. **中文乱码**: Windows下可能显示乱码,这是正常的GBK编码问题
2. **图表刷新**: 重新运行`python run_workflow.py`后,需要重新生成图表
3. **MLflow端口**: 如果5000端口被占用,可以改用其他端口: `--port 5001`
4. **Jupyter图表**: 交互式图表需要在Jupyter环境中才能正常显示

---

**当前MLflow UI状态**: ✅ 运行中 (http://127.0.0.1:5000)
**最新图表**: backtest_analysis.png (470KB)

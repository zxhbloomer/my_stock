# å‚æ•°ä¼˜åŒ–è„šæœ¬æ”¯æŒTop50å› å­ - å¼€å‘è®¾è®¡æ–¹æ¡ˆ

**æ–¹æ¡ˆç¼–å·**: 2025-11-16-212757
**åˆ›å»ºæ—¶é—´**: 2025-11-16 21:27:57
**è®¾è®¡è€…**: Linus Torvalds (ä»£ç†)
**éœ€æ±‚æ¥æº**: ç”¨æˆ·éœ€è¦å¯¹Top50å› å­è¿›è¡ŒLightGBMå‚æ•°ä¼˜åŒ–

---

## 1. é—®é¢˜è¯Šæ–­ä¸æ ¹å› åˆ†æ

### 1.1 é—®é¢˜æè¿°

**ç°çŠ¶**:
- `scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py` ç¡¬ç¼–ç ä½¿ç”¨ **Alpha158** handler (ç¬¬82-103è¡Œ)
- ç”¨æˆ·çš„å®é™…ç­–ç•¥ä½¿ç”¨ **Top50å› å­** (`configs/workflow_config_top50.yaml`)
- å¯¼è‡´å‚æ•°ä¼˜åŒ–ç»“æœä¸é€‚ç”¨äºTop50å› å­ç­–ç•¥

**å½±å“**:
- ä¼˜åŒ–å‡ºçš„LightGBMå‚æ•°æ˜¯åŸºäº158ä¸ªå› å­çš„,ç”¨åœ¨50ä¸ªå› å­ä¸Šå¯èƒ½**ä¸æ˜¯æœ€ä¼˜**
- ç­–ç•¥è¡¨ç°å¯èƒ½ä½äºé¢„æœŸ(ICã€å¹´åŒ–æ”¶ç›Šç‡ã€ä¿¡æ¯æ¯”ç‡ç­‰æŒ‡æ ‡æ¬¡ä¼˜)

### 1.2 æ ¹æœ¬åŸå› 

**ç¡¬ç¼–ç é—®é¢˜**:
```python
# å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py:82-103è¡Œ
'handler': {
    'class': 'Alpha158',  # â† ç¡¬ç¼–ç !æ— æ³•æ›´æ¢å› å­é›†
    'module_path': 'qlib.contrib.data.handler',
    'kwargs': {...}
}
```

**è®¾è®¡ç¼ºé™·**:
- è¿åäº†"é…ç½®å¤–éƒ¨åŒ–"åŸåˆ™
- ç‰¹æ®Šæƒ…å†µç¡¬ç¼–ç (LinusåŸåˆ™:"å¥½ä»£ç æ²¡æœ‰ç‰¹æ®Šæƒ…å†µ")
- ä¸æ”¯æŒè‡ªå®šä¹‰å› å­é›†çš„å‚æ•°ä¼˜åŒ–

### 1.3 è°ƒç”¨é“¾è·¯åˆ†æ

```
ç”¨æˆ·æ‰§è¡Œå‘½ä»¤
    â†“
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py --n-iter 30
    â†“
ImprovedLightGBMOptimizer.__init__()
    â†“
optimizer.load_dataset()  â† ç¬¬73è¡Œ
    â†“
ç¡¬ç¼–ç Alpha158 handler (ç¬¬82-103è¡Œ)  â† é—®é¢˜æ‰€åœ¨!
    â†“
init_instance_by_config(dataset_config)  â† ç¬¬112è¡Œ
    â†“
è´å¶æ–¯ä¼˜åŒ– â†’ æœ€ä¼˜å‚æ•°
    â†“
ç”Ÿæˆworkflow_config_optimized_csi300.yaml  â† ä½†ä»ç„¶ç”¨Alpha158!
```

---

## 2. KISSåŸåˆ™7é—®é¢˜å›ç­”

### é—®é¢˜1: "è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„?"
âœ… **çœŸé—®é¢˜**
- ç”¨æˆ·å·²ç»å®ŒæˆICåˆ†æå¹¶ç”ŸæˆTop50å› å­é…ç½®
- å‚æ•°ä¼˜åŒ–è„šæœ¬ç¡®å®ç¡¬ç¼–ç Alpha158,æ— æ³•ä½¿ç”¨Top50å› å­
- è¿™å¯¼è‡´ä¼˜åŒ–å‚æ•°ä¸å®é™…ç­–ç•¥ä¸åŒ¹é…

### é—®é¢˜2: "æœ‰æ›´ç®€å•çš„æ–¹æ³•å—?"
âœ… **å·²æ˜¯æœ€ç®€æ–¹æ¡ˆ**
- æ–¹æ¡ˆæ ¸å¿ƒ:ä»YAMLè¯»å–handleré…ç½®,æ›¿æ¢ç¡¬ç¼–ç 
- åªéœ€ä¿®æ”¹`load_dataset()`æ–¹æ³•å’Œ`__init__()`å‚æ•°
- å¤ç”¨Qlibçš„`init_instance_by_config`,ä¸éœ€è¦é‡å†™é€»è¾‘

### é—®é¢˜3: "ä¼šç ´åä»€ä¹ˆå—?"
âœ… **é›¶ç ´åæ€§**
- ä¸ä¿®æ”¹ç°æœ‰é…ç½®æ–‡ä»¶(åªè¯»å–)
- æ·»åŠ å¯é€‰çš„`--config`å‚æ•°(å‘åå…¼å®¹)
- ä¸å½±å“å…¶ä»–è„šæœ¬(30_è¿è¡Œå·¥ä½œæµ.pyã€22_è®­ç»ƒTopå› å­æ¨¡å‹.pyç­‰)

### é—®é¢˜4: "å½“å‰é¡¹ç›®çœŸçš„éœ€è¦è¿™ä¸ªåŠŸèƒ½å—?"
âœ… **éå¸¸éœ€è¦**
- ç”¨æˆ·å·²å®Œæˆå› å­ç­›é€‰å·¥ä½œæµ(00â†’10â†’20â†’21â†’22)
- å‚æ•°ä¼˜åŒ–æ˜¯é‡åŒ–ç­–ç•¥æ ‡å‡†æµç¨‹çš„ä¸‹ä¸€æ­¥
- è¿™æ˜¯å®ç°æœ€ä¼˜ç­–ç•¥è¡¨ç°çš„å¿…è¦æ­¥éª¤

### é—®é¢˜5: "è¿™ä¸ªé—®é¢˜è¿‡åº¦è®¾è®¡äº†å—?æœ‰ç¼ºå°‘å¿…è¦ä¿¡æ¯å—?èƒ½å¦ç»§ç»­è¯„ä¼°?"
âœ… **è®¾è®¡åˆç†,ä¿¡æ¯å……è¶³**
- å·²æ”¶é›†Top50é…ç½®çš„å®Œæ•´handlerç»“æ„
- å·²åˆ†æ30_è¿è¡Œå·¥ä½œæµ.pyçš„åŠ è½½æ–¹å¼(ä½¿ç”¨init_instance_by_config)
- å·²éªŒè¯handleré…ç½®çš„å¯ç§»æ¤æ€§
- æ•°æ®æ”¯æ’‘å……åˆ†,å¯ä»¥ç»§ç»­è®¾è®¡

### é—®é¢˜6: "è¯é¢˜æ˜¯å¦æ¨¡ç³Š,æ˜¯å¦ä¼šå¯¼è‡´å¹»è§‰çš„äº§ç”Ÿ?"
âœ… **æ¸…æ™°æ˜ç¡®**
- éœ€æ±‚æ˜ç¡®:è®©å‚æ•°ä¼˜åŒ–è„šæœ¬æ”¯æŒä»»æ„é…ç½®æ–‡ä»¶çš„å› å­
- æŠ€æœ¯è·¯å¾„æ¸…æ™°:è¯»å–YAMLé…ç½® â†’ æå–handler â†’ ä¼ ç»™datasetåˆå§‹åŒ–
- ä¸å­˜åœ¨æ¨¡ç³Šæ¦‚å¿µ

### é—®é¢˜7: "æ˜¯å¦å·²ç»å­¦ä¹ äº†å…³äºä»£ç å®æ–½çš„æ³¨æ„äº‹é¡¹çš„å†…å®¹?"
âœ… **å·²æ·±åˆ»å­¦ä¹ **

**å­¦ä¹ å†…å®¹**:

1. **Qlibçš„HandleråŠ è½½æœºåˆ¶**:
   - `init_instance_by_config`ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨å®ä¾‹åŒ–handler
   - æ”¯æŒAlpha158å’ŒDataHandlerLPä¸¤ç§handler
   - handleré…ç½®æ˜¯è‡ªåŒ…å«çš„,å¯ä»¥ç›´æ¥ä»YAMLè¯»å–

2. **DataHandlerLP vs Alpha158çš„åŒºåˆ«**:
   - Alpha158:å†…ç½®158ä¸ªå›ºå®šå› å­
   - DataHandlerLP:é€šè¿‡QlibDataLoaderåŠ è½½è‡ªå®šä¹‰å› å­è¡¨è¾¾å¼
   - Top50é…ç½®ä½¿ç”¨DataHandlerLPæ–¹å¼

3. **é¡¹ç›®ä¸­çš„handlerä½¿ç”¨æ¨¡å¼**:
   - `22_è®­ç»ƒTopå› å­æ¨¡å‹.py`å·²æœ‰å®Œæ•´çš„DataHandlerLPé…ç½®ç”Ÿæˆé€»è¾‘
   - `30_è¿è¡Œå·¥ä½œæµ.py`ä½¿ç”¨`init_instance_by_config`åŠ¨æ€åŠ è½½handler
   - é…ç½®æ–‡ä»¶ä¸­handleréƒ¨åˆ†å¯ä»¥ç›´æ¥å¤åˆ¶ä½¿ç”¨

4. **é…ç½®å¤–éƒ¨åŒ–åŸåˆ™**:
   - é¿å…ç¡¬ç¼–ç ,ä»é…ç½®æ–‡ä»¶è¯»å–
   - ä½¿å‚æ•°ä¼˜åŒ–è„šæœ¬é€šç”¨åŒ–,æ”¯æŒä»»æ„å› å­é›†
   - ç¬¦åˆQlibçš„è®¾è®¡å“²å­¦å’Œæœ€ä½³å®è·µ

---

## 3. æ–¹æ¡ˆè®¾è®¡

### 3.1 æ ¸å¿ƒè®¾è®¡æ€æƒ³

> "Bad programmers worry about the code. Good programmers worry about data structures."
>
> "å¥½ä»£ç æ²¡æœ‰ç‰¹æ®Šæƒ…å†µ" - æ¶ˆé™¤Alpha158çš„ç¡¬ç¼–ç ç‰¹æ®Šæƒ…å†µ

**è®¾è®¡åŸåˆ™**:
1. **é…ç½®å¤–éƒ¨åŒ–**: ä»YAMLè¯»å–handleré…ç½®,ä¸ç¡¬ç¼–ç 
2. **é€šç”¨åŒ–**: æ”¯æŒä»»æ„é…ç½®æ–‡ä»¶(Alpha158ã€Top50ã€æˆ–ä»»ä½•è‡ªå®šä¹‰å› å­)
3. **å‘åå…¼å®¹**: ä¿ç•™åŸæœ‰åŠŸèƒ½,æ·»åŠ å¯é€‰å‚æ•°
4. **ç®€æ´ä¼˜å…ˆ**: æœ€å°æ”¹åŠ¨,å¤ç”¨ç°æœ‰Qlibæœºåˆ¶

### 3.2 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | ä¿®æ”¹å†…å®¹ |
|---------|---------|---------|
| `scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py` | ç¼–è¾‘ | 1. ä¿®æ”¹`__init__`æ·»åŠ config_pathå‚æ•°<br>2. ä¿®æ”¹`load_dataset`ä»YAMLè¯»å–handler<br>3. ä¿®æ”¹`generate_yaml_config`ä¿å­˜æ­£ç¡®çš„handleré…ç½®<br>4. ä¿®æ”¹mainæ·»åŠ --configå‚æ•° |
| `docs/å‚æ•°ä¼˜åŒ–ä½¿ç”¨æŒ‡å—.md` | æ–°å»º | åˆ›å»ºè¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹ |

### 3.3 æŠ€æœ¯å®ç°æ–¹æ¡ˆ

#### 3.3.1 æ•°æ®ç»“æ„è®¾è®¡

**æ ¸å¿ƒæ•°æ®æµ**:
```
ç”¨æˆ·æŒ‡å®šconfigæ–‡ä»¶
    â†“
è¯»å–YAML â†’ æå–task.dataset.kwargs.handleré…ç½®
    â†“
å¤åˆ¶handleré…ç½®åˆ°dataset_config
    â†“
init_instance_by_config â†’ è‡ªåŠ¨è¯†åˆ«handlerç±»å‹
    â†“
è®­ç»ƒæ¨¡å‹ â†’ ä¼˜åŒ–å‚æ•°
    â†“
ä¿å­˜æ—¶ä½¿ç”¨åŸå§‹handleré…ç½®(ä¸å†ç¡¬ç¼–ç Alpha158)
```

**å…³é”®æ•°æ®ç»“æ„**:
```python
# ä»YAMLè¯»å–çš„handleré…ç½®(å®Œæ•´ç»“æ„)
handler_config = {
    'class': 'DataHandlerLP',  # æˆ– 'Alpha158'
    'module_path': 'qlib.contrib.data.handler',
    'kwargs': {
        'start_time': '2008-01-01',
        'end_time': '2020-12-31',
        'instruments': 'csi500',
        'data_loader': {  # DataHandlerLPç‰¹æœ‰
            'class': 'QlibDataLoader',
            'kwargs': {
                'config': {
                    'feature': [...],  # Top50å› å­è¡¨è¾¾å¼åˆ—è¡¨
                    'label': [...]
                },
                'freq': 'day'
            }
        },
        'infer_processors': [...],
        'learn_processors': [...]
    }
}
```

#### 3.3.2 ä»£ç ä¿®æ”¹æ–¹æ¡ˆ

**ä¿®æ”¹1: `__init__`æ–¹æ³•æ·»åŠ config_pathå‚æ•°**

```python
def __init__(
    self,
    config_path=None,  # â† æ–°å¢:é…ç½®æ–‡ä»¶è·¯å¾„
    instruments='csi300',
    train_start='2008-01-01',
    train_end='2014-12-31',
    valid_start='2015-01-01',
    valid_end='2016-12-31'
):
    self.config_path = config_path
    self.instruments = instruments
    self.train_start = train_start
    self.train_end = train_end
    self.valid_start = valid_start
    self.valid_end = valid_end
    self.dataset = None
    self.best_params = None
    self.best_score = None
    self.optimization_history = []
    self.handler_config = None  # â† æ–°å¢:ä¿å­˜ä»YAMLè¯»å–çš„handleré…ç½®
```

**ä¿®æ”¹2: `load_dataset`æ–¹æ³•ä»YAMLè¯»å–handler**

```python
def load_dataset(self):
    """åŠ è½½æ•°æ®é›†(ä»é…ç½®æ–‡ä»¶è¯»å–handleræˆ–ä½¿ç”¨é»˜è®¤Alpha158)"""
    print("åŠ è½½æ•°æ®é›†...")

    # å¦‚æœæŒ‡å®šäº†é…ç½®æ–‡ä»¶,ä»ä¸­è¯»å–handleré…ç½®
    if self.config_path:
        print(f"ä»é…ç½®æ–‡ä»¶è¯»å–handler: {self.config_path}")
        with open(self.config_path, 'r', encoding='utf-8') as f:
            config = yaml.safe_load(f)

        # æå–handleré…ç½®
        self.handler_config = config['task']['dataset']['kwargs']['handler']

        # æ›´æ–°instruments(ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å€¼)
        if 'instruments' in self.handler_config['kwargs']:
            self.instruments = self.handler_config['kwargs']['instruments']
            print(f"  ä½¿ç”¨é…ç½®ä¸­çš„è‚¡ç¥¨æ± : {self.instruments}")

        print(f"  Handlerç±»å‹: {self.handler_config['class']}")

    else:
        # é»˜è®¤ä½¿ç”¨Alpha158(å‘åå…¼å®¹)
        print("æœªæŒ‡å®šé…ç½®æ–‡ä»¶,ä½¿ç”¨é»˜è®¤Alpha158 handler")
        self.handler_config = {
            'class': 'Alpha158',
            'module_path': 'qlib.contrib.data.handler',
            'kwargs': {
                'instruments': self.instruments,
                'start_time': '2008-01-01',
                'end_time': '2020-12-31',
                'fit_start_time': '2008-01-01',
                'fit_end_time': '2014-12-31',
                'infer_processors': [
                    {
                        'class': 'RobustZScoreNorm',
                        'kwargs': {'fields_group': 'feature', 'clip_outlier': True}
                    },
                    {'class': 'Fillna', 'kwargs': {'fields_group': 'feature'}}
                ],
                'learn_processors': [
                    {'class': 'DropnaLabel'},
                    {'class': 'CSRankNorm', 'kwargs': {'fields_group': 'label'}}
                ],
                'label': ['Ref($close, -2) / Ref($close, -1) - 1']
            }
        }

    # æ„å»ºdataseté…ç½®(ä½¿ç”¨è¯»å–çš„handleré…ç½®)
    dataset_config = {
        'class': 'DatasetH',
        'module_path': 'qlib.data.dataset',
        'kwargs': {
            'handler': self.handler_config,  # â† ä½¿ç”¨ä»YAMLè¯»å–çš„é…ç½®
            'segments': {
                'train': (self.train_start, self.train_end),
                'valid': (self.valid_start, self.valid_end),
                'test': ('2017-01-01', '2020-12-31')
            }
        }
    }

    self.dataset = init_instance_by_config(dataset_config)
    print("[OK] æ•°æ®é›†åŠ è½½å®Œæˆ")
```

**ä¿®æ”¹3: `generate_yaml_config`æ–¹æ³•ä¿å­˜æ­£ç¡®çš„handleré…ç½®**

```python
def generate_yaml_config(self, yaml_path):
    """ç”Ÿæˆå¯ç›´æ¥ä½¿ç”¨çš„YAMLé…ç½®æ–‡ä»¶"""
    yaml_path = Path(yaml_path)
    yaml_path.parent.mkdir(parents=True, exist_ok=True)

    # è¯»å–åŸå§‹é…ç½®ä½œä¸ºæ¨¡æ¿(å¦‚æœæœ‰æŒ‡å®šconfig_path)
    if self.config_path:
        print(f"åŸºäºé…ç½®æ–‡ä»¶ç”Ÿæˆ: {self.config_path}")
        with open(self.config_path, 'r', encoding='utf-8') as f:
            base_config = yaml.safe_load(f)
    else:
        # ä½¿ç”¨é»˜è®¤Alpha158é…ç½®ä½œä¸ºæ¨¡æ¿
        base_config = self._get_default_alpha158_config()

    # æ›´æ–°æ¨¡å‹å‚æ•°(ä¿ç•™åŸæœ‰handleré…ç½®)
    base_config['task']['model']['kwargs'].update(self.best_params)
    base_config['task']['model']['kwargs']['num_threads'] = 20

    # ä¿å­˜é…ç½®
    with open(yaml_path, 'w', encoding='utf-8') as f:
        yaml.dump(base_config, f, allow_unicode=True, sort_keys=False)

    print(f"[OK] å·²ç”Ÿæˆå¯ç”¨é…ç½®æ–‡ä»¶: {yaml_path}")
    print(f"\nğŸ’¡ å¯ç›´æ¥è¿è¡Œ: python scripts/30_è¿è¡Œå·¥ä½œæµ.py {yaml_path}")
```

**ä¿®æ”¹4: mainå‡½æ•°æ·»åŠ --configå‚æ•°**

```python
if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(
        description='LightGBMå‚æ•°ä¼˜åŒ–(æ”¯æŒä»»æ„é…ç½®æ–‡ä»¶)',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ç¤ºä¾‹:
  # ä¼˜åŒ–Alpha158å› å­(é»˜è®¤)
  python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py --n-iter 30

  # ä¼˜åŒ–Top50å› å­
  python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py --config configs/workflow_config_top50.yaml --n-iter 30

  # ä¼˜åŒ–è‡ªå®šä¹‰é…ç½®
  python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py --config configs/my_custom_config.yaml --n-iter 50
        """
    )
    parser.add_argument(
        '--config',
        type=str,
        default=None,
        help='é…ç½®æ–‡ä»¶è·¯å¾„(YAMLæ ¼å¼)ã€‚å¦‚ä¸æŒ‡å®šåˆ™ä½¿ç”¨é»˜è®¤Alpha158é…ç½®'
    )
    parser.add_argument('--n-iter', type=int, default=30, help='ä¼˜åŒ–è¿­ä»£æ¬¡æ•°(é»˜è®¤30)')
    parser.add_argument('--init-points', type=int, default=5, help='åˆå§‹éšæœºæ¢ç´¢ç‚¹æ•°(é»˜è®¤5)')
    parser.add_argument('--instruments', type=str, default='csi300', help='è‚¡ç¥¨æ± (ä»…åœ¨ä¸æŒ‡å®š--configæ—¶æœ‰æ•ˆ)')

    args = parser.parse_args()

    # åˆå§‹åŒ–Qlib
    print("åˆå§‹åŒ–Qlib...")
    qlib.init(provider_uri='D:/Data/my_stock', region='cn')
    print("[OK] Qlibåˆå§‹åŒ–å®Œæˆ\n")

    # åˆ›å»ºä¼˜åŒ–å™¨
    optimizer = ImprovedLightGBMOptimizer(
        config_path=args.config,  # â† ä¼ å…¥é…ç½®æ–‡ä»¶è·¯å¾„
        instruments=args.instruments,  # å¦‚æœæœ‰config,æ­¤å‚æ•°ä¼šè¢«è¦†ç›–
        train_start='2008-01-01',
        train_end='2014-12-31',
        valid_start='2015-01-01',
        valid_end='2016-12-31'
    )

    # æ‰§è¡Œä¼˜åŒ–
    best_params = optimizer.optimize(
        n_iter=args.n_iter,
        init_points=args.init_points
    )

    # ä¿å­˜ç»“æœ
    optimizer.save_results()

    print("\n[OK] å‚æ•°ä¼˜åŒ–å®Œæˆ!")
    print("\nğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ:")
    print("   1. æŸ¥çœ‹ä¼˜åŒ–ç»“æœ: docs/lightgbm_optimization_results_improved.txt")
    if args.config:
        # ç”ŸæˆåŸºäºåŸé…ç½®çš„ä¼˜åŒ–ç‰ˆæœ¬
        base_name = Path(args.config).stem
        optimized_config = f"configs/{base_name}_optimized.yaml"
        print(f"   2. ä½¿ç”¨ä¼˜åŒ–åçš„é…ç½®: python scripts/30_è¿è¡Œå·¥ä½œæµ.py {optimized_config}")
    else:
        print(f"   2. ä½¿ç”¨ä¼˜åŒ–åçš„é…ç½®: python scripts/30_è¿è¡Œå·¥ä½œæµ.py configs/workflow_config_optimized_{args.instruments}.yaml")
    print("   3. å¯¹æ¯”æ€§èƒ½æå‡\n")
```

### 3.4 ä½¿ç”¨æ–¹å¼å¯¹æ¯”

**ä¼˜åŒ–å‰(åªèƒ½ä¼˜åŒ–Alpha158)**:
```bash
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py --n-iter 30 --instruments csi300
# åªèƒ½ä¼˜åŒ–Alpha158çš„158ä¸ªå› å­
```

**ä¼˜åŒ–å(æ”¯æŒä»»æ„é…ç½®)**:
```bash
# æ–¹å¼1: ä¼˜åŒ–Top50å› å­
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py \
  --config configs/workflow_config_top50.yaml \
  --n-iter 30

# æ–¹å¼2: ä¼˜åŒ–Alpha158(å‘åå…¼å®¹)
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py --n-iter 30

# æ–¹å¼3: ä¼˜åŒ–ä»»æ„è‡ªå®šä¹‰é…ç½®
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py \
  --config configs/my_custom_factors.yaml \
  --n-iter 50
```

---

## 4. é£é™©åˆ†æä¸ç¼“è§£æªæ–½

### 4.1 æŠ€æœ¯é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|---------|------|---------|
| YAMLé…ç½®æ ¼å¼ä¸å…¼å®¹ | ğŸŸ¡ ä¸­ | è¯»å–handleré…ç½®å¤±è´¥ | æ·»åŠ try-exceptå¼‚å¸¸å¤„ç†,ç»™å‡ºæ¸…æ™°é”™è¯¯æç¤º |
| handleré…ç½®ç¼ºå°‘å¿…è¦å­—æ®µ | ğŸŸ¢ ä½ | datasetåˆå§‹åŒ–å¤±è´¥ | éªŒè¯handleré…ç½®çš„å®Œæ•´æ€§,æç¤ºç”¨æˆ·æ£€æŸ¥YAML |
| æ—¶é—´èŒƒå›´ä¸ä¸€è‡´ | ğŸŸ¡ ä¸­ | ä¼˜åŒ–ç»“æœä¸å‡†ç¡® | ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„æ—¶é—´èŒƒå›´,å¿½ç•¥å‘½ä»¤è¡Œå‚æ•° |
| å‘åå…¼å®¹æ€§ç ´å | ğŸŸ¢ ä½ | è€ç”¨æˆ·æ— æ³•ä½¿ç”¨ | ä¿ç•™é»˜è®¤Alpha158è¡Œä¸º,--configä¸ºå¯é€‰å‚æ•° |

### 4.2 ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|---------|------|---------|
| ä¼˜åŒ–è€—æ—¶è¿‡é•¿ | ğŸŸ¢ ä½ | Top50å› å­ä¼˜åŒ–å¯èƒ½è¾ƒå¿« | å› å­æ•°å‡å°‘,ä¼˜åŒ–é€Ÿåº¦åè€Œæ›´å¿« |
| è¿‡æ‹Ÿåˆé£é™© | ğŸŸ¡ ä¸­ | éªŒè¯é›†è¡¨ç°å¥½,æµ‹è¯•é›†å·® | æ–‡æ¡£ä¸­è¯´æ˜éœ€è¦åœ¨æµ‹è¯•é›†éªŒè¯ |
| å‚æ•°ä¸é€šç”¨ | ğŸŸ¡ ä¸­ | ä¸åŒå› å­é›†éœ€è¦ä¸åŒå‚æ•° | è¿™æ­£æ˜¯æœ¬æ¬¡ä¿®æ”¹çš„ç›®æ ‡ |

---

## 5. æµ‹è¯•è®¡åˆ’

### 5.1 å•å…ƒæµ‹è¯•(æ‰‹åŠ¨éªŒè¯)

**æµ‹è¯•ç”¨ä¾‹1: ä½¿ç”¨Top50é…ç½®ä¼˜åŒ–**
```bash
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py \
  --config configs/workflow_config_top50.yaml \
  --n-iter 5  # å¿«é€Ÿæµ‹è¯•,ä»…5æ¬¡è¿­ä»£
```
**é¢„æœŸç»“æœ**:
- âœ… æ­£ç¡®è¯»å–DataHandlerLPé…ç½®
- âœ… åŠ è½½50ä¸ªå› å­è¡¨è¾¾å¼
- âœ… ç”Ÿæˆ`configs/workflow_config_top50_optimized.yaml`
- âœ… handlerç±»å‹ä¿æŒä¸ºDataHandlerLP

**æµ‹è¯•ç”¨ä¾‹2: ä½¿ç”¨é»˜è®¤Alpha158é…ç½®(å‘åå…¼å®¹)**
```bash
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py --n-iter 5
```
**é¢„æœŸç»“æœ**:
- âœ… ä½¿ç”¨é»˜è®¤Alpha158 handler
- âœ… åŠ è½½158ä¸ªå› å­
- âœ… ç”Ÿæˆ`configs/workflow_config_optimized_csi300.yaml`

**æµ‹è¯•ç”¨ä¾‹3: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨**
```bash
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py --config configs/not_exist.yaml
```
**é¢„æœŸç»“æœ**:
- âœ… æ¸…æ™°çš„é”™è¯¯æç¤º:"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: configs/not_exist.yaml"

### 5.2 é›†æˆæµ‹è¯•

**å®Œæ•´å·¥ä½œæµæµ‹è¯•**:
```bash
# æ­¥éª¤1: ä¼˜åŒ–Top50å‚æ•°
python scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py \
  --config configs/workflow_config_top50.yaml \
  --n-iter 30

# æ­¥éª¤2: ä½¿ç”¨ä¼˜åŒ–åçš„é…ç½®è¿è¡Œå›æµ‹
python scripts/30_è¿è¡Œå·¥ä½œæµ.py configs/workflow_config_top50_optimized.yaml

# æ­¥éª¤3: å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½
# ä¼˜åŒ–å‰: configs/workflow_config_top50.yamlçš„å›æµ‹ç»“æœ
# ä¼˜åŒ–å: configs/workflow_config_top50_optimized.yamlçš„å›æµ‹ç»“æœ
```

**éªŒè¯æŒ‡æ ‡**:
- ICå‡å€¼åº”è¯¥æå‡(ä»0.03x â†’ 0.04+)
- ICä¿¡æ¯æ¯”ç‡(IC_IR)åº”è¯¥æå‡
- å¹´åŒ–æ”¶ç›Šç‡åº”è¯¥æå‡
- æœ€å¤§å›æ’¤åº”è¯¥é™ä½æˆ–ä¿æŒ

---

## 6. æ–‡æ¡£æ¸…å•

| æ–‡æ¡£åç§° | ç±»å‹ | å†…å®¹ |
|---------|------|------|
| `docs/å‚æ•°ä¼˜åŒ–ä½¿ç”¨æŒ‡å—.md` | ç”¨æˆ·æ–‡æ¡£ | è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜ã€ç¤ºä¾‹ã€FAQ |
| `scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py` | ä»£ç æ³¨é‡Š | å…³é”®å‡½æ•°çš„ä¸­æ–‡æ³¨é‡Š |
| `docs/design/2025-11-16-212757-å‚æ•°ä¼˜åŒ–è„šæœ¬æ”¯æŒTop50å› å­-æ–¹æ¡ˆ.md` | è®¾è®¡æ–‡æ¡£ | æœ¬æ–‡æ¡£ |

---

## 7. å®æ–½è®¡åˆ’

### 7.1 ç¼–ç å‰æ£€æŸ¥æ¸…å•(AIè‡ªæŸ¥)

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¼–ç å‰æ£€æŸ¥æ¸…å•(AIè‡ªæŸ¥)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… è°ƒç”¨é“¾è·¯è¿½è¸ª: å·²å®Œæ•´è¿½è¸ªå‚æ•°ä¼˜åŒ–è„šæœ¬çš„datasetåŠ è½½é“¾è·¯
âœ… æœåŠ¡èŒè´£ç†è§£: å·²ç†è§£ImprovedLightGBMOptimizerçš„èŒè´£å’Œå®ç°
âœ… æ•°æ®è½¬æ¢è¯†åˆ«: å·²è¯†åˆ«YAMLé…ç½® â†’ handleré…ç½® â†’ datasetåˆå§‹åŒ–çš„è½¬æ¢è¿‡ç¨‹
âœ… é‡å¤å®ç°æ£€æŸ¥: å·²æ£€æŸ¥30_è¿è¡Œå·¥ä½œæµ.pyå’Œ22_è®­ç»ƒTopå› å­æ¨¡å‹.py,å¤ç”¨å…¶æ¨¡å¼
âœ… KISSåŸåˆ™ç¡®è®¤: å·²å›ç­”KISSåŸåˆ™çš„æ‰€æœ‰7ä¸ªé—®é¢˜,ç¡®è®¤æ–¹æ¡ˆç®€æ´åˆç†
âœ… æ•°æ®æ”¯æ’‘å®Œæ•´: å·²æ”¶é›†Top50é…ç½®ç»“æ„ã€handleråŠ è½½æ–¹å¼ã€Qlibæœºåˆ¶ç­‰æ•°æ®
âœ… æ–¹æ¡ˆæ–‡æ¡£å®Œæˆ: å·²åˆ¶å®šè¯¦ç»†çš„å®æ–½æ–¹æ¡ˆæ–‡æ¡£
â³ ç”¨æˆ·æ‰¹å‡†ç¡®è®¤: ç­‰å¾…ç”¨æˆ·å¯¹æ–¹æ¡ˆçš„æ‰¹å‡†ç¡®è®¤
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 7.2 å®æ–½æ­¥éª¤

1. **ç­‰å¾…ç”¨æˆ·å®¡æ‰¹æ–¹æ¡ˆ** â† å½“å‰é˜¶æ®µ
2. ä¿®æ”¹`scripts/å‚æ•°ä¼˜åŒ–_æ”¹è¿›ç‰ˆ.py`
3. åˆ›å»º`docs/å‚æ•°ä¼˜åŒ–ä½¿ç”¨æŒ‡å—.md`
4. æ·»åŠ ä»£ç æ³¨é‡Š
5. æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
6. QAä»£ç è¯„å®¡
7. å®ŒæˆéªŒæ”¶

---

## 8. é™„å½•

### 8.1 å…³é”®ä»£ç ç‰‡æ®µå‚è€ƒ

**30_è¿è¡Œå·¥ä½œæµ.pyçš„åŠ è½½æ–¹å¼**(ç¬¬16-40è¡Œ):
```python
# è¯»å–é…ç½®æ–‡ä»¶
with open(config_path, 'r', encoding='utf-8') as f:
    config = yaml.safe_load(f)

# è·å–ä»»åŠ¡é…ç½®
task_config = config['task']

# åˆå§‹åŒ–æ•°æ®é›†(è‡ªåŠ¨è¯†åˆ«handlerç±»å‹)
dataset = init_instance_by_config(task_config['dataset'])
```

**22_è®­ç»ƒTopå› å­æ¨¡å‹.pyçš„handleré…ç½®ç”Ÿæˆ**(ç¬¬101-129è¡Œ):
```python
handler_config = {
    "class": "DataHandlerLP",
    "module_path": "qlib.contrib.data.handler",
    "kwargs": {
        "start_time": "2008-01-01",
        "end_time": "2020-12-31",
        "instruments": "csi300",
        "data_loader": {
            "class": "QlibDataLoader",
            "kwargs": {
                "config": {
                    "feature": selected_features,  # Top 50å› å­è¡¨è¾¾å¼
                    "label": ["Ref($close, -2)/Ref($close, -1) - 1"]
                },
                "freq": "day"
            }
        },
        "infer_processors": [...],
        "learn_processors": [...]
    }
}
```

### 8.2 å‚è€ƒèµ„æ–™

- Qlibå®˜æ–¹æ–‡æ¡£: https://qlib.readthedocs.io/
- Qlib Handleræœºåˆ¶: `qlib/contrib/data/handler.py`
- LightGBMå‚æ•°è¯´æ˜: https://lightgbm.readthedocs.io/

---

**æ–¹æ¡ˆçŠ¶æ€**: âœ… è®¾è®¡å®Œæˆ,ç­‰å¾…ç”¨æˆ·å®¡æ‰¹

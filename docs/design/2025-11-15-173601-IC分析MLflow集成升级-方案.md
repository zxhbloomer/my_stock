# ICåˆ†æMLflowé›†æˆå‡çº§æ–¹æ¡ˆ

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|-----|------|
| **æ–¹æ¡ˆåç§°** | ICåˆ†æç»“æœå­˜å‚¨ä»docs/å‡çº§åˆ°mlruns/ï¼ˆMLflowé›†æˆï¼‰ |
| **è®¾è®¡æ—¥æœŸ** | 2025-11-15 |
| **è®¾è®¡äººå‘˜** | Claude Code (stockå¼€å‘æµç¨‹ Agent) |
| **éœ€æ±‚æ¥æº** | ç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼š"æ¨èæ–¹æ¡ˆ 1ï¼šmlruns/ (Qlib å®˜æ–¹é£æ ¼)ï¼Œè¿›è¡Œå‡çº§æ”¹é€ " |
| **ä¼˜å…ˆçº§** | ğŸ”´ é«˜ï¼ˆåŸºç¡€è®¾æ–½è§„èŒƒåŒ–ï¼‰ |
| **é¢„è®¡å·¥æœŸ** | 4-5å°æ—¶ |

---

## ğŸ¯ éœ€æ±‚åˆ†æ

### å½“å‰ç—›ç‚¹

**1. å­˜å‚¨ä½ç½®ä¸è§„èŒƒ**
- ICåˆ†æç»“æœä¿å­˜åœ¨ `docs/` ç›®å½•ï¼ˆæ–‡æ¡£ç›®å½•ï¼‰
- ä¸ç¬¦åˆQlibå®˜æ–¹æ¨èçš„MLflowå®éªŒç®¡ç†æ–¹å¼
- ä¸é¡¹ç›®å…¶ä»–å®éªŒï¼ˆtrain_model, backtest_analysisï¼‰ç®¡ç†æ–¹å¼ä¸ä¸€è‡´

**2. å¯è¿½æº¯æ€§å·®**
- æ— å†å²è®°å½•ï¼šæ¯æ¬¡è¿è¡Œè¦†ç›–åŸæ–‡ä»¶ï¼Œä¸¢å¤±å†å²æ•°æ®
- æ— å‚æ•°è®°å½•ï¼šæ— æ³•è¿½æº¯ä½¿ç”¨çš„poolã€æ—¶é—´èŒƒå›´ã€é˜ˆå€¼
- æ— æŒ‡æ ‡è®°å½•ï¼šæ— æ³•å¯¹æ¯”ä¸åŒè¿è¡Œçš„ICç»Ÿè®¡æŒ‡æ ‡

**3. åä½œä¸å¯¹æ¯”å›°éš¾**
- æ— æ³•å¯¹æ¯”CSI300 vs CSI500çš„ICåˆ†æç»“æœ
- æ— æ³•å¯¹æ¯”ä¸åŒæ—¶é—´æ®µçš„å› å­æœ‰æ•ˆæ€§å˜åŒ–
- å›¢é˜Ÿåä½œæ—¶æ— æ³•å…±äº«å†å²å®éªŒè®°å½•

### å‡çº§ç›®æ ‡

**1. ç»Ÿä¸€å®éªŒç®¡ç†**
- âœ… é‡‡ç”¨MLflowæ ‡å‡†åŒ–å®éªŒè¿½è¸ª
- âœ… ä¸train_modelã€backtest_analysisä¿æŒä¸€è‡´
- âœ… ç¬¦åˆQlibå®˜æ–¹æœ€ä½³å®è·µ
- âœ… **ç®€åŒ–è®¾è®¡**ï¼šä»…ä½¿ç”¨MLflowï¼Œä¸ä¿ç•™docs/åŒå†™

**2. å®Œæ•´å¯è¿½æº¯**
- âœ… è®°å½•å‚æ•°ï¼špool, ic_threshold, start_time, end_time
- âœ… è®°å½•æŒ‡æ ‡ï¼šic_mean, strong_factors_count, retention_rate
- âœ… ä¿å­˜artifactsï¼šCSVæ–‡ä»¶å’ŒPNGå›¾è¡¨åˆ°mlruns/

**3. ä¾¿æ·æŸ¥è¯¢ä¸å¯¹æ¯”**
- âœ… é€šè¿‡MLflow UIæŸ¥çœ‹å†å²è®°å½•
- âœ… æ”¯æŒå®éªŒå¯¹æ¯”ï¼ˆä¸åŒpoolã€ä¸åŒæ—¶é—´æ®µï¼‰
- âœ… è‡ªåŠ¨ç®¡ç†å®éªŒç‰ˆæœ¬

---

## ğŸ“Š ç°çŠ¶æ•°æ®æ”¶é›†

### ç°æœ‰MLflowå®éªŒ

**é¡¹ç›®ä¸­å·²å­˜åœ¨çš„MLflowå®éªŒ**ï¼š

| å®éªŒID | å®éªŒåç§° | è¯´æ˜ | æ–‡ä»¶æ•° |
|-------|---------|-----|--------|
| 427366007907294756 | workflow_lightgbm_alpha158 | LightGBMæ¨¡å‹è®­ç»ƒ | ~40 files |
| 827097837948471560 | backtest_analysis | å›æµ‹åˆ†æ | ~95 files |
| 553742989189059577 | (unnamed) | å…¶ä»–å®éªŒ | ~30 files |

**ç›®å½•ç»“æ„**ï¼š
```
mlruns/
â”œâ”€â”€ 0/                          # é»˜è®¤å®éªŒ
â”œâ”€â”€ 427366007907294756/         # workflow_lightgbm_alpha158
â”‚   â”œâ”€â”€ meta.yaml
â”‚   â”œâ”€â”€ fe55bac1.../            # Run 1
â”‚   â”‚   â”œâ”€â”€ artifacts/
â”‚   â”‚   â”‚   â”œâ”€â”€ trained_model
â”‚   â”‚   â”‚   â””â”€â”€ pred.pkl
â”‚   â”‚   â”œâ”€â”€ metrics/
â”‚   â”‚   â”‚   â”œâ”€â”€ l2.train
â”‚   â”‚   â”‚   â””â”€â”€ l2.valid
â”‚   â”‚   â””â”€â”€ params/
â”‚   â””â”€â”€ e985d2cd.../            # Run 2
â””â”€â”€ 827097837948471560/         # backtest_analysis
    â””â”€â”€ cfd95724.../
        â”œâ”€â”€ artifacts/
        â”‚   â”œâ”€â”€ pred.pkl
        â”‚   â”œâ”€â”€ portfolio_analysis/
        â”‚   â””â”€â”€ sig_analysis/
        â””â”€â”€ metrics/
            â”œâ”€â”€ IC
            â”œâ”€â”€ ICIR
            â””â”€â”€ (many more metrics)
```

### å½“å‰ICåˆ†æè¾“å‡º

**å½“å‰ä¿å­˜è·¯å¾„**ï¼š`docs/`ï¼ˆä¸å­˜åœ¨ï¼Œå› ä¸ºæœªè¿è¡Œè¿‡ICåˆ†æï¼‰

**é¢„æœŸè¾“å‡ºæ–‡ä»¶**ï¼ˆæ ¹æ®ä»£ç æ¨æµ‹ï¼‰ï¼š
1. `ic_analysis_full.csv` - å®Œæ•´209ä¸ªå› å­çš„ICåˆ†æ
2. `strong_factors_list.csv` - ç­›é€‰åçš„~95ä¸ªå¼ºå› å­
3. `ic_distribution.png` - ICåˆ†å¸ƒç›´æ–¹å›¾
4. `ic_timeseries_top5.png` - Top 5å› å­ICæ—¶åºå›¾
5. `strong_factors_by_library.png` - æŒ‰åº“ç»Ÿè®¡æŸ±çŠ¶å›¾

### ä»£ç ä¾èµ–å…³ç³»

**æ–‡ä»¶ä¾èµ–é“¾**ï¼š
```
scripts/20_ic_analysis.py
    â†“ ç”Ÿæˆ
docs/strong_factors_list.csv
    â†“ åŠ è½½
utils/factor_selector.py
    â†“ ä½¿ç”¨
handlers/optimized_handler.py
    â†“ æä¾›ç‰¹å¾
run_workflow.py
```

**å…³é”®ä»£ç ä½ç½®**ï¼š
- `scripts/20_ic_analysis.py:235-293` - ä¿å­˜é€»è¾‘ï¼ˆå½“å‰ä¿å­˜åˆ°docs/ï¼‰
- `utils/factor_selector.py:39-55` - åŠ è½½é€»è¾‘ï¼ˆå½“å‰ä»`../docs/strong_factors_list.csv`åŠ è½½ï¼‰

---

## ğŸ—ï¸ æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### æ•´ä½“æ¶æ„

**é‡‡ç”¨ç®€åŒ–å®æ–½ç­–ç•¥ï¼ˆKISSåŸåˆ™ï¼‰**ï¼š

```
Phase 1: ICåˆ†æMLflowé›†æˆï¼ˆå¿…é¡»ï¼‰
â”œâ”€â”€ scripts/20_ic_analysis.py: é›†æˆMLflow
â”œâ”€â”€ ä»…ä¿å­˜åˆ°mlruns/ï¼ˆä¸åŒå†™docs/ï¼‰
â””â”€â”€ CLIå‚æ•°ä¿æŒä¸å˜

Phase 2: FactorSelectoré€‚é…ï¼ˆå¿…é¡»ï¼‰
â”œâ”€â”€ utils/factor_selector.py: ä»MLflowåŠ è½½
â”œâ”€â”€ ç§»é™¤CSVä¾èµ–ï¼Œç›´æ¥ä½¿ç”¨MLflow
â””â”€â”€ æµ‹è¯•ç«¯åˆ°ç«¯æµç¨‹
```

### æ–¹æ¡ˆè¯¦ç»†è®¾è®¡

#### Phase 1: ICåˆ†æMLflowé›†æˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`scripts/20_ic_analysis.py`

**æ”¹é€ ç‚¹1ï¼šå¯¼å…¥MLflow API**
```python
from qlib.workflow import R
```

**æ”¹é€ ç‚¹2ï¼šrun_ic_analysis()å‡½æ•°æ”¹é€ **

**åŸå§‹é€»è¾‘**ï¼ˆlines 231-331ï¼‰ï¼š
```python
def run_ic_analysis(instruments, start_time, end_time, output_dir='../docs'):
    """è¿è¡ŒICåˆ†æ"""

    # 1. åŠ è½½å› å­
    all_features, all_names, all_libraries = load_all_factors()

    # 2. è®¡ç®—IC
    ic_results = []
    for expr, name, lib in zip(...):
        result = calculate_ic_for_factor(...)
        ic_results.append(result)

    # 3. ç”ŸæˆDataFrame
    ic_df = pd.DataFrame([...])

    # 4. ä¿å­˜åˆ°docs/ï¼ˆå½“å‰æ–¹å¼ï¼‰
    output_path = Path(output_dir)
    ic_df.to_csv(output_path / 'ic_analysis_full.csv', ...)
    strong_factors.to_csv(output_path / 'strong_factors_list.csv', ...)

    # 5. ç”Ÿæˆå›¾è¡¨
    generate_charts(ic_df, strong_factors, ic_results, output_path)

    return ic_df, strong_factors
```

**æ”¹é€ åé€»è¾‘**ï¼š
```python
def run_ic_analysis(
    instruments,
    start_time='2017-01-01',
    end_time='2020-12-31',
    pool_name='csi300',
    ic_threshold=0.01
):
    """è¿è¡ŒICåˆ†æï¼ˆMLflowé›†æˆç‰ˆ - ç®€åŒ–è®¾è®¡ï¼‰"""

    # MLflowå®éªŒå¼€å§‹
    with R.start(experiment_name="ic_analysis"):
        # 1. è®°å½•å‚æ•°
        R.log_params(
            pool=pool_name,
            ic_threshold=ic_threshold,
            start_time=start_time,
            end_time=end_time,
            stock_count=len(instruments)
        )

        # 2. åŠ è½½å› å­
        all_features, all_names, all_libraries = load_all_factors()
        R.log_params(total_factors=len(all_features))

        # 3. è®¡ç®—ICï¼ˆé€»è¾‘ä¸å˜ï¼‰
        ic_results = []
        for expr, name, lib in tqdm(zip(...)):
            result = calculate_ic_for_factor(...)
            ic_results.append(result)

        # 4. ç”ŸæˆDataFrame
        ic_df = pd.DataFrame([...])
        strong_factors = ic_df[abs(ic_df['ic_mean']) > ic_threshold].copy()
        strong_factors = strong_factors.sort_values('ic_mean', ascending=False)

        # 5. è®°å½•æŒ‡æ ‡
        R.log_metrics(
            ic_mean_all=ic_df['ic_mean'].mean(),
            ic_mean_strong=strong_factors['ic_mean'].mean(),
            strong_factors_count=len(strong_factors),
            retention_rate=len(strong_factors) / len(ic_df),
            ic_max=strong_factors['ic_mean'].max(),
            ic_min=strong_factors['ic_mean'].min()
        )

        # 6. ä¿å­˜artifactsåˆ°MLflow
        R.save_objects(
            ic_analysis_full=ic_df,           # DataFrameä¼šè‡ªåŠ¨ä¿å­˜ä¸ºpkl
            strong_factors_list=strong_factors
        )

        # 7. ç”Ÿæˆå›¾è¡¨å¹¶ä¿å­˜åˆ°artifacts
        import tempfile
        with tempfile.TemporaryDirectory() as tmpdir:
            tmp_path = Path(tmpdir)
            generate_charts(ic_df, strong_factors, ic_results, tmp_path)

            # è®°å½•å›¾è¡¨ä¸ºartifacts
            R.log_artifact(str(tmp_path / 'ic_distribution.png'))
            R.log_artifact(str(tmp_path / 'ic_timeseries_top5.png'))
            R.log_artifact(str(tmp_path / 'strong_factors_by_library.png'))

        # 8. è·å–recorder_id
        recorder = R.get_recorder()
        recorder_id = recorder.id

        print(f"\nâœ… MLflowè®°å½•ID: {recorder_id}")
        print(f"   æŸ¥çœ‹ç»“æœ: mlflow ui (http://localhost:5000)")

        return ic_df, strong_factors, recorder_id
```

**æ”¹é€ ç‚¹3ï¼šmain()å‡½æ•°æ”¹é€ **

**ç§»é™¤å‚æ•°**ï¼š
```python
# ç§»é™¤ --output-dir å‚æ•°ï¼ˆä¸å†éœ€è¦ï¼‰
```

**è°ƒç”¨ä¿®æ”¹**ï¼š
```python
ic_df, strong_factors, recorder_id = run_ic_analysis(
    instruments=instruments,
    start_time=args.start_time,
    end_time=args.end_time,
    pool_name=args.pool,
    ic_threshold=0.01
)

print(f"\nä¸‹ä¸€æ­¥:")
print(f"  1. æŸ¥çœ‹MLflow UI: mlflow ui")
print(f"  2. Recorder ID: {recorder_id}")
print(f"  3. ä½¿ç”¨å› å­ç­›é€‰å™¨: python -m utils.factor_selector")
```

#### Phase 2: FactorSelector MLflowé›†æˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`utils/factor_selector.py`

**æ”¹é€ ç‚¹1ï¼šæ„é€ å‡½æ•°ç®€åŒ–**

**åŸå§‹ä»£ç **ï¼ˆlines 22-37ï¼‰ï¼š
```python
def __init__(
    self,
    ic_threshold: float = 0.01,
    ic_csv_path: str = '../docs/strong_factors_list.csv'
):
    self.ic_threshold = ic_threshold
    self.ic_csv_path = ic_csv_path
    self.ic_data = None
    self.selected_factors = None
```

**æ”¹é€ å**ï¼š
```python
def __init__(
    self,
    ic_threshold: float = 0.01,
    experiment_name: str = 'ic_analysis',
    recorder_id: Optional[str] = None
):
    """
    åˆå§‹åŒ–å› å­ç­›é€‰å™¨ï¼ˆä»…ä½¿ç”¨MLflowï¼‰

    Args:
        ic_threshold: ICé˜ˆå€¼ï¼ˆé»˜è®¤0.01ï¼‰
        experiment_name: MLflowå®éªŒåç§°ï¼ˆé»˜è®¤ic_analysisï¼‰
        recorder_id: MLflowè¿è¡ŒIDï¼ˆNoneåˆ™ä½¿ç”¨æœ€æ–°ï¼‰
    """
    self.ic_threshold = ic_threshold
    self.experiment_name = experiment_name
    self.recorder_id = recorder_id
    self.ic_data = None
    self.selected_factors = None
```

**æ”¹é€ ç‚¹2ï¼šload_ic_results()æ–¹æ³•æ”¹é€ **

**åŸå§‹ä»£ç **ï¼ˆlines 39-55ï¼‰ï¼š
```python
def load_ic_results(self) -> pd.DataFrame:
    """åŠ è½½ICåˆ†æç»“æœ"""
    if not os.path.exists(self.ic_csv_path):
        raise FileNotFoundError(...)

    self.ic_data = pd.read_csv(self.ic_csv_path, encoding='utf-8-sig')
    print(f"âœ… å·²åŠ è½½ {len(self.ic_data)} ä¸ªå› å­çš„ICåˆ†æç»“æœ")
    return self.ic_data
```

**æ”¹é€ å**ï¼š
```python
def load_ic_results(self) -> pd.DataFrame:
    """
    åŠ è½½ICåˆ†æç»“æœï¼ˆä»…ä»MLflowåŠ è½½ - ç®€åŒ–è®¾è®¡ï¼‰
    """
    from qlib.workflow import R

    # è·å–recorder
    if self.recorder_id:
        recorder = R.get_recorder(
            recorder_id=self.recorder_id,
            experiment_name=self.experiment_name
        )
        print(f"â„¹ï¸  ä½¿ç”¨æŒ‡å®šè¿è¡Œ: {self.recorder_id}")
    else:
        # ä½¿ç”¨æœ€æ–°çš„recorder
        from qlib.workflow.recorder import Recorder
        recorders = Recorder.list_recorders(experiment_name=self.experiment_name)
        if not recorders:
            raise ValueError(
                f"å®éªŒ '{self.experiment_name}' ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è¿è¡Œè®°å½•\n"
                f"è¯·å…ˆè¿è¡Œ IC åˆ†æ:\n"
                f"  python scripts/20_ic_analysis.py --pool csi300"
            )

        # æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œå–æœ€æ–°
        recorder = sorted(recorders, key=lambda r: r.info['start_time'], reverse=True)[0]
        self.recorder_id = recorder.id
        print(f"â„¹ï¸  è‡ªåŠ¨é€‰æ‹©æœ€æ–°è¿è¡Œ: {self.recorder_id}")

    # åŠ è½½ic_analysis_full
    self.ic_data = recorder.load_object('ic_analysis_full')

    print(f"âœ… å·²ä»MLflowåŠ è½½ICåˆ†æç»“æœ")
    print(f"   - Recorder ID: {self.recorder_id}")
    print(f"   - å› å­æ•°é‡: {len(self.ic_data)}")

    return self.ic_data
```

**æ”¹é€ ç‚¹3ï¼šå‘½ä»¤è¡Œå‚æ•°å¢å¼º**

**æ–°å¢å‚æ•°**ï¼ˆlines 301-316ï¼‰ï¼š
```python
parser.add_argument(
    '--experiment-name',
    type=str,
    default='ic_analysis',
    help='MLflowå®éªŒåç§°ï¼ˆé»˜è®¤ic_analysisï¼‰'
)
parser.add_argument(
    '--recorder-id',
    type=str,
    default=None,
    help='MLflowè¿è¡ŒIDï¼ˆNoneåˆ™ä½¿ç”¨æœ€æ–°ï¼‰'
)
```

**main()è°ƒç”¨ä¿®æ”¹**ï¼š
```python
# åˆ›å»ºç­›é€‰å™¨
selector = FactorSelector(
    ic_threshold=args.ic_threshold,
    experiment_name=args.experiment_name,
    recorder_id=args.recorder_id
)
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•ç”¨ä¾‹

#### TC1: ICåˆ†æMLflowä¿å­˜æµ‹è¯•

**å‰ç½®æ¡ä»¶**ï¼š
- Qlibå·²åˆå§‹åŒ–
- ç¯å¢ƒæ£€æŸ¥é€šè¿‡

**æµ‹è¯•æ­¥éª¤**ï¼š
```bash
cd D:\2025_project\99_quantify\python\my_stock
C:\Users\Administrator\miniconda3\envs\mystock\python.exe scripts\20_ic_analysis.py --pool csi300
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… åœ¨`mlruns/`ä¸‹ç”Ÿæˆæ–°å®éªŒï¼š`ic_analysis`
- âœ… ä¿å­˜artifactsï¼š`ic_analysis_full`, `strong_factors_list`, 3ä¸ªPNG
- âœ… è®°å½•paramsï¼špool=csi300, start_time, end_time, ic_threshold
- âœ… è®°å½•metricsï¼šic_mean_all, strong_factors_count, retention_rate
- âœ… åŒæ—¶ä¿å­˜åˆ°`docs/`ï¼ˆåŒå†™æ¨¡å¼ï¼‰
- âœ… è¾“å‡ºrecorder_id

#### TC2: FactorSelector MLflowåŠ è½½æµ‹è¯•

**å‰ç½®æ¡ä»¶**ï¼š
- TC1å·²å®Œæˆ

**æµ‹è¯•æ­¥éª¤**ï¼š
```bash
cd D:\2025_project\99_quantify\python\my_stock
C:\Users\Administrator\miniconda3\envs\mystock\python.exe -m utils.factor_selector --experiment-name ic_analysis
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è‡ªåŠ¨æ‰¾åˆ°æœ€æ–°çš„ic_analysisè¿è¡Œ
- âœ… æˆåŠŸåŠ è½½`ic_analysis_full`
- âœ… è¾“å‡ºæ•°æ®æ¥æºï¼šMLflow
- âœ… ç­›é€‰å¼ºå› å­æ­£å¸¸

#### TC3: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•

**å‰ç½®æ¡ä»¶**ï¼š
- TC1, TC2å·²å®Œæˆ

**æµ‹è¯•æ­¥éª¤**ï¼š
```python
# æµ‹è¯•è„šæœ¬
import qlib
qlib.init(provider_uri='D:/Data/my_stock', region='cn')

from handlers.optimized_handler import OptimizedHandler

handler = OptimizedHandler(
    instruments='csi300',
    start_time='2017-01-01',
    end_time='2020-12-31',
    ic_threshold=0.01,
    use_factor_selector=True
)

features = handler.get_feature_config()
print(f"è·å–åˆ° {len(features)} ä¸ªå› å­")
assert len(features) > 0, "å› å­æ•°é‡åº”å¤§äº0"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… FactorSelectorè‡ªåŠ¨ä»MLflowåŠ è½½
- âœ… OptimizedHandlerè·å–åˆ°~95ä¸ªå¼ºå› å­
- âœ… æ— é”™è¯¯å’Œè­¦å‘Š

#### TC4: é”™è¯¯æç¤ºæµ‹è¯•

**å‰ç½®æ¡ä»¶**ï¼š
- æœªè¿è¡ŒICåˆ†æï¼ˆmlruns/ic_analysisä¸å­˜åœ¨ï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
```bash
C:\Users\Administrator\miniconda3\envs\mystock\python.exe -m utils.factor_selector
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ¸…æ™°é”™è¯¯æç¤ºï¼š"å®éªŒ 'ic_analysis' ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è¿è¡Œè®°å½•"
- âœ… æç¤ºè¿è¡ŒICåˆ†æå‘½ä»¤

### æµ‹è¯•è¦†ç›–ç‡

| åŠŸèƒ½ç‚¹ | æµ‹è¯•ç”¨ä¾‹ | è¦†ç›–ç‡ |
|-------|---------|--------|
| MLflowä¿å­˜ | TC1 | 100% |
| MLflowåŠ è½½ | TC2 | 100% |
| é”™è¯¯æç¤º | TC4 | 100% |
| ç«¯åˆ°ç«¯é›†æˆ | TC3 | 100% |
| å‚æ•°è®°å½• | TC1 | 100% |
| æŒ‡æ ‡è®°å½• | TC1 | 100% |

---

## ğŸ“ ç›®å½•ç»“æ„å˜åŒ–

### æ”¹é€ å‰

```
my_stock/
â”œâ”€â”€ docs/                       # æ–‡æ¡£ç›®å½•ï¼ˆä¸åº”å­˜æ”¾æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ ic_analysis_full.csv   âŒ æ•°æ®æ–‡ä»¶
â”‚   â”œâ”€â”€ strong_factors_list.csv âŒ æ•°æ®æ–‡ä»¶
â”‚   â”œâ”€â”€ ic_distribution.png     âŒ æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ ...
â”œâ”€â”€ mlruns/                     # MLflowå®éªŒç®¡ç†
â”‚   â”œâ”€â”€ 427366007907294756/    âœ… train_model
â”‚   â””â”€â”€ 827097837948471560/    âœ… backtest_analysis
â””â”€â”€ scripts/
    â””â”€â”€ 20_ic_analysis.py
```

### æ”¹é€ å

```
my_stock/
â”œâ”€â”€ docs/                       # æ–‡æ¡£ç›®å½•ï¼ˆä¸å†ä¿å­˜ICåˆ†ææ•°æ®ï¼‰
â”‚   â””â”€â”€ design/                 # è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ mlruns/                     # MLflowå®éªŒç®¡ç†ï¼ˆç»Ÿä¸€å­˜å‚¨ï¼‰
â”‚   â”œâ”€â”€ 427366007907294756/    âœ… train_model
â”‚   â”œâ”€â”€ 827097837948471560/    âœ… backtest_analysis
â”‚   â””â”€â”€ <new-experiment-id>/   âœ… ic_analysisï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ meta.yaml
â”‚       â””â”€â”€ <run-id>/
â”‚           â”œâ”€â”€ artifacts/
â”‚           â”‚   â”œâ”€â”€ ic_analysis_full.pkl
â”‚           â”‚   â”œâ”€â”€ strong_factors_list.pkl
â”‚           â”‚   â”œâ”€â”€ ic_distribution.png
â”‚           â”‚   â”œâ”€â”€ ic_timeseries_top5.png
â”‚           â”‚   â””â”€â”€ strong_factors_by_library.png
â”‚           â”œâ”€â”€ metrics/
â”‚           â”‚   â”œâ”€â”€ ic_mean_all
â”‚           â”‚   â”œâ”€â”€ strong_factors_count
â”‚           â”‚   â””â”€â”€ retention_rate
â”‚           â””â”€â”€ params/
â”‚               â”œâ”€â”€ pool
â”‚               â”œâ”€â”€ ic_threshold
â”‚               â”œâ”€â”€ start_time
â”‚               â””â”€â”€ end_time
â””â”€â”€ scripts/
    â””â”€â”€ 20_ic_analysis.py       âœ… é›†æˆMLflow
```

---

## âš ï¸ é£é™©ä¸ç¼“è§£

| é£é™© | ä¸¥é‡æ€§ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|--------|------|-----|---------|
| **é¦–æ¬¡ä½¿ç”¨æ—¶æ— æ•°æ®** | ğŸŸ¢ ä½ | é«˜ | ç”¨æˆ·å›°æƒ‘ | æ¸…æ™°é”™è¯¯æç¤ºï¼š"è¯·å…ˆè¿è¡ŒICåˆ†æ" |
| **MLflow APIé”™è¯¯** | ğŸŸ¡ ä¸­ | ä½ | ICåˆ†æå¤±è´¥ | æ·»åŠ try-exceptï¼Œæä¾›æ¸…æ™°é”™è¯¯æç¤º |
| **å­¦ä¹ æˆæœ¬** | ğŸŸ¢ ä½ | ä¸­ | ç”¨æˆ·å›°æƒ‘ | æä¾›è¯¦ç»†æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹ |
| **æ€§èƒ½å¼€é”€** | ğŸŸ¢ ä½ | ä½ | ICåˆ†æå˜æ…¢ | MLflowå†™å…¥<1ç§’ï¼Œå¯å¿½ç•¥ |

---

## ğŸ“… å®æ–½è®¡åˆ’

### Phase 1: ICåˆ†æMLflowé›†æˆï¼ˆå¿…é¡»ï¼‰

**å·¥æœŸ**ï¼š1.5-2å°æ—¶

**ä»»åŠ¡æ¸…å•**ï¼š
1. âœ… ä¿®æ”¹`scripts/20_ic_analysis.py`
   - å¯¼å…¥`qlib.workflow.R`
   - é›†æˆ`R.start()`, `R.log_params()`, `R.log_metrics()`, `R.save_objects()`
   - ç§»é™¤`--output-dir`å‚æ•°
   - æ›´æ–°è¾“å‡ºæç¤º
2. âœ… æµ‹è¯•ICåˆ†æç”ŸæˆMLflowè®°å½•ï¼ˆTC1ï¼‰

### Phase 2: FactorSelectoré€‚é…ï¼ˆå¿…é¡»ï¼‰

**å·¥æœŸ**ï¼š1.5-2å°æ—¶

**ä»»åŠ¡æ¸…å•**ï¼š
1. âœ… ä¿®æ”¹`utils/factor_selector.py`
   - ç®€åŒ–æ„é€ å‡½æ•°ï¼ˆç§»é™¤ic_csv_pathï¼‰
   - æ”¹é€ `load_ic_results()`ï¼ˆä»…ä»MLflowåŠ è½½ï¼‰
   - æ›´æ–°CLIå‚æ•°ï¼ˆç§»é™¤--force-csvï¼‰
2. âœ… æµ‹è¯•FactorSelectorä»MLflowåŠ è½½ï¼ˆTC2ï¼‰
3. âœ… æµ‹è¯•ç«¯åˆ°ç«¯é›†æˆï¼ˆTC3ï¼‰
4. âœ… æµ‹è¯•é”™è¯¯æç¤ºï¼ˆTC4ï¼‰

---

## ğŸ“ ä½¿ç”¨è¯´æ˜æ›´æ–°

### è¿è¡ŒICåˆ†æï¼ˆæ–°ï¼‰

```bash
# åŸºæœ¬ç”¨æ³•ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°MLflowï¼‰
python scripts/20_ic_analysis.py --pool csi300

# æŒ‡å®šæ—¶é—´èŒƒå›´
python scripts/20_ic_analysis.py --pool csi500 --start-time 2015-01-01 --end-time 2022-12-31

# æŸ¥çœ‹MLflow UI
mlflow ui
# è®¿é—® http://localhost:5000
```

### ä½¿ç”¨å› å­ç­›é€‰å™¨ï¼ˆæ–°ï¼‰

```bash
# ä»æœ€æ–°çš„MLflowè®°å½•åŠ è½½
python -m utils.factor_selector

# æŒ‡å®šç‰¹å®šçš„è¿è¡ŒID
python -m utils.factor_selector --recorder-id <run-id>
```

### Pythonä»£ç ä¸­ä½¿ç”¨ï¼ˆæ–°ï¼‰

```python
import qlib
qlib.init(provider_uri='D:/Data/my_stock', region='cn')

# æ–¹å¼1ï¼šä½¿ç”¨FactorSelectorï¼ˆè‡ªåŠ¨ä»MLflowåŠ è½½ï¼‰
from utils.factor_selector import FactorSelector

selector = FactorSelector(
    ic_threshold=0.01,
    experiment_name='ic_analysis',  # MLflowå®éªŒå
    recorder_id=None  # Noneåˆ™ä½¿ç”¨æœ€æ–°
)
selector.load_ic_results()
selector.select_strong_factors()
features = selector.get_feature_config_for_handler()

# æ–¹å¼2ï¼šä½¿ç”¨OptimizedHandlerï¼ˆå†…éƒ¨è°ƒç”¨FactorSelectorï¼‰
from handlers.optimized_handler import OptimizedHandler

handler = OptimizedHandler(
    instruments='csi300',
    start_time='2017-01-01',
    end_time='2020-12-31',
    use_factor_selector=True  # è‡ªåŠ¨ä»MLflowåŠ è½½
)
features = handler.get_feature_config()
```

---

## âœ… éªŒæ”¶æ ‡å‡†

| éªŒæ”¶é¡¹ | æ ‡å‡† | éªŒè¯æ–¹æ³• |
|-------|------|---------|
| MLflowå®éªŒåˆ›å»º | âœ… mlruns/ä¸‹ç”Ÿæˆic_analysiså®éªŒ | æ£€æŸ¥ç›®å½•ç»“æ„ |
| å‚æ•°è®°å½• | âœ… è®°å½•pool, ic_threshold, start_time, end_time | MLflow UIæŸ¥çœ‹params |
| æŒ‡æ ‡è®°å½• | âœ… è®°å½•ic_mean_all, strong_factors_count, retention_rate | MLflow UIæŸ¥çœ‹metrics |
| Artifactsä¿å­˜ | âœ… ä¿å­˜2ä¸ªpkl, 3ä¸ªpng | æ£€æŸ¥artifactsç›®å½• |
| MLflowåŠ è½½ | âœ… FactorSelectorå¯ä»MLflowåŠ è½½ | è¿è¡ŒTC2 |
| é”™è¯¯æç¤º | âœ… æœªè¿è¡ŒICåˆ†ææ—¶æ¸…æ™°æç¤º | è¿è¡ŒTC4 |
| ç«¯åˆ°ç«¯é›†æˆ | âœ… OptimizedHandleræ­£å¸¸å·¥ä½œ | è¿è¡ŒTC3 |
| ä»£ç ç®€æ´æ€§ | âœ… ç§»é™¤åŒå†™é€»è¾‘ï¼Œä»£ç æ›´ç®€æ´ | Code Review |
| æ–‡æ¡£æ›´æ–° | âœ… ä½¿ç”¨è¯´æ˜å·²æ›´æ–° | æ£€æŸ¥CLAUDE.md |

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **Qlibå®˜æ–¹æ–‡æ¡£**
   - MLflowé›†æˆ: https://qlib.readthedocs.io/en/latest/component/recorder.html
   - Recorder API: https://qlib.readthedocs.io/en/latest/reference/api.html#recorder

2. **é¡¹ç›®ç°æœ‰å®ç°**
   - `run_workflow.py:33-47` - train_modelçš„MLflowä½¿ç”¨ç¤ºä¾‹
   - `run_workflow.py:89-110` - backtest_analysisçš„MLflowä½¿ç”¨ç¤ºä¾‹

3. **MLflowæ–‡æ¡£**
   - Tracking API: https://mlflow.org/docs/latest/tracking.html
   - Artifacts: https://mlflow.org/docs/latest/tracking.html#artifact-stores

---

## ğŸ” é™„å½•ï¼šä»£ç å¯¹æ¯”

### A. run_ic_analysis()å‡½æ•°å¯¹æ¯”

**æ”¹é€ å‰**ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰ï¼š
```python
# ä¿å­˜åˆ°docs/ç›®å½•
output_path = Path(output_dir)
output_path.mkdir(parents=True, exist_ok=True)

full_result_path = output_path / 'ic_analysis_full.csv'
ic_df.to_csv(full_result_path, index=False, encoding='utf-8-sig')

strong_result_path = output_path / 'strong_factors_list.csv'
strong_factors.to_csv(strong_result_path, index=False, encoding='utf-8-sig')

# ç”Ÿæˆå›¾è¡¨
generate_charts(ic_df, strong_factors, ic_results, output_path)

return ic_df, strong_factors
```

**æ”¹é€ å**ï¼ˆæ ¸å¿ƒé€»è¾‘ - ç®€åŒ–ç‰ˆï¼‰ï¼š
```python
with R.start(experiment_name="ic_analysis"):
    # è®°å½•å‚æ•°
    R.log_params(pool=pool_name, ic_threshold=ic_threshold, ...)

    # è®¡ç®—ICï¼ˆé€»è¾‘ä¸å˜ï¼‰
    ...

    # è®°å½•æŒ‡æ ‡
    R.log_metrics(ic_mean_all=..., strong_factors_count=..., ...)

    # ä¿å­˜artifactsåˆ°MLflow
    R.save_objects(ic_analysis_full=ic_df, strong_factors_list=strong_factors)

    # è®°å½•å›¾è¡¨
    with tempfile.TemporaryDirectory() as tmpdir:
        generate_charts(..., Path(tmpdir))
        R.log_artifact(str(Path(tmpdir) / 'ic_distribution.png'))
        R.log_artifact(str(Path(tmpdir) / 'ic_timeseries_top5.png'))
        R.log_artifact(str(Path(tmpdir) / 'strong_factors_by_library.png'))

    recorder_id = R.get_recorder().id
    return ic_df, strong_factors, recorder_id
```

### B. FactorSelector.load_ic_results()å¯¹æ¯”

**æ”¹é€ å‰**ï¼š
```python
def load_ic_results(self) -> pd.DataFrame:
    if not os.path.exists(self.ic_csv_path):
        raise FileNotFoundError(...)

    self.ic_data = pd.read_csv(self.ic_csv_path, encoding='utf-8-sig')
    print(f"âœ… å·²åŠ è½½ {len(self.ic_data)} ä¸ªå› å­çš„ICåˆ†æç»“æœ")
    return self.ic_data
```

**æ”¹é€ å**ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š
```python
def load_ic_results(self) -> pd.DataFrame:
    from qlib.workflow import R

    # è·å–recorderï¼ˆæŒ‡å®šIDæˆ–æœ€æ–°ï¼‰
    if self.recorder_id:
        recorder = R.get_recorder(recorder_id=self.recorder_id, experiment_name=self.experiment_name)
    else:
        from qlib.workflow.recorder import Recorder
        recorders = Recorder.list_recorders(experiment_name=self.experiment_name)
        if not recorders:
            raise ValueError("è¯·å…ˆè¿è¡ŒICåˆ†æ")
        recorder = sorted(recorders, key=lambda r: r.info['start_time'], reverse=True)[0]
        self.recorder_id = recorder.id

    # ä»MLflowåŠ è½½
    self.ic_data = recorder.load_object('ic_analysis_full')
    print(f"âœ… å·²ä»MLflowåŠ è½½ICåˆ†æç»“æœ (Recorder: {self.recorder_id})")
    return self.ic_data
```

---

## ğŸ“Š æ€»ç»“

### æ”¹é€ æ”¶ç›Š

| ç»´åº¦ | æ”¹é€ å‰ | æ”¹é€ å | æå‡ |
|-----|--------|--------|------|
| **å®éªŒç®¡ç†** | æ— æ ‡å‡†åŒ–ç®¡ç† | MLflowç»Ÿä¸€ç®¡ç† | âœ… è§„èŒƒåŒ– |
| **å†å²è¿½æº¯** | æ— å†å²è®°å½• | å®Œæ•´å‚æ•°/æŒ‡æ ‡/artifacts | âœ… å¯è¿½æº¯ |
| **å®éªŒå¯¹æ¯”** | æ‰‹åŠ¨å¯¹æ¯”CSV | MLflow UIè‡ªåŠ¨å¯¹æ¯” | âœ… ä¾¿æ·æ€§ |
| **å›¢é˜Ÿåä½œ** | æ–‡ä»¶ä¼ é€’ | MLflowå…±äº« | âœ… åä½œæ€§ |
| **ä»£ç ç®€æ´** | ä¿å­˜åˆ°docs/ | ä»…MLflowï¼Œæ›´ç®€æ´ | âœ… KISSåŸåˆ™ |

### æŠ€æœ¯äº®ç‚¹

1. âœ… **KISSåŸåˆ™**ï¼šå¤ç”¨ç°æœ‰MLflowæ¨¡å¼ï¼Œä»£ç å¢é‡å°ï¼ˆ~80è¡Œï¼‰ï¼Œä»…ç”¨MLflowä¸åŒå†™
2. âœ… **ç®€æ´è®¾è®¡**ï¼šç§»é™¤CSVä¾èµ–ï¼Œç»Ÿä¸€ä½¿ç”¨MLflowï¼Œä»£ç æ›´æ¸…æ™°
3. âœ… **ç»Ÿä¸€è§„èŒƒ**ï¼šä¸train_modelã€backtest_analysisä¿æŒä¸€è‡´
4. âœ… **æ¸…æ™°é”™è¯¯**ï¼šæœªè¿è¡ŒICåˆ†ææ—¶ï¼Œæ˜ç¡®æç¤ºç”¨æˆ·æ“ä½œ

### å®æ–½å»ºè®®

- âœ… **ç«‹å³å®æ–½**ï¼šPhase 1 + Phase 2ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œ3-4å°æ—¶ï¼‰
- âœ… **ç®€æ´ä¼˜å…ˆ**ï¼šä»…ä½¿ç”¨MLflowï¼Œä¸ä¿ç•™docs/åŒå†™ï¼Œéµå¾ªKISSåŸåˆ™
- âœ… **åˆ†é˜¶æ®µæµ‹è¯•**ï¼šæ¯ä¸ªPhaseå®Œæˆåç«‹å³æµ‹è¯•ï¼Œç¡®ä¿è´¨é‡
- âœ… **æ–‡æ¡£åŒæ­¥**ï¼šä½¿ç”¨è¯´æ˜ä¸ä»£ç åŒæ­¥æ›´æ–°

---

**æ–¹æ¡ˆçŠ¶æ€**ï¼šâœ… è®¾è®¡å®Œæˆï¼Œç­‰å¾…å®¡æ‰¹

**ä¸‹ä¸€æ­¥**ï¼šè¿›å…¥é˜¶æ®µ5 - æ–¹æ¡ˆå®¡æ‰¹ç­‰å¾…
